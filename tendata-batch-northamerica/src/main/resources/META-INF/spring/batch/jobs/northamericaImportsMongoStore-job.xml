<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.springframework.org/schema/batch 
        http://www.springframework.org/schema/batch/spring-batch.xsd
        http://www.springframework.org/schema/beans 
        http://www.springframework.org/schema/beans/spring-beans.xsd">
    
    <import resource="configuration/northamericaImports-common.xml"/>
    
    <job id="northamericaImportsMongoStoreJob" xmlns="http://www.springframework.org/schema/batch" >
        <step id="northamericaImportsMongoStoreStep1">
            <tasklet >
                <chunk reader="aggregateItemReader" processor="compositeItemProcessor" writer="compositeMongoItemWriter" 
                    commit-interval="${batch.northamerica_imports.mongodb.commit-interval:1000}"
                    skip-limit="${batch.northamerica_imports.mongodb.skip-limit:1}" >
                    <skippable-exception-classes>
                        <include class="org.springframework.batch.item.file.FlatFileParseException"/>
                    </skippable-exception-classes>
                    <streams>
                        <stream ref="fileItemReader"/>
                    </streams>
                </chunk>
            </tasklet>
        </step>
        <listeners>
            <listener ref="notificationExecutionsListener"/>
        </listeners>
    </job>
    
    <bean id="compositeItemProcessor" class="org.springframework.batch.item.support.CompositeItemProcessor" >
        <property name="delegates">
            <list>
                <ref bean="aggregateItemProcessor"/>
                <bean class="cn.tendata.batch.northamerica.item.file.FileMetadataItemProcessor" scope="step">
                    <property name="resource"
                        value="#{T(cn.tendata.batch.util.JobParameterUtils).getInputPathToFile(jobParameters)}"/>
                </bean>
            </list>
        </property>
    </bean>
    
    <bean id="compositeMongoItemWriter" class="org.springframework.batch.item.support.ClassifierCompositeItemWriter">
        <property name="classifier">
            <bean class="org.springframework.classify.BackToBackPatternClassifier">
                <property name="routerDelegate">
                    <bean class="cn.tendata.batch.item.SpelEvaluationItemClassifier">
                        <constructor-arg value="{'13','15','18'}.contains(#root['BillTypeCode_00']) ? 
                            'M' + (#root['RecordStatusIndicator_10'] ?: 'E') : 'G' + (#root['RecordStatusIndicator_10'] ?: 'E')"/>
                    </bean>

                </property>
                <property name="matcherMap">
                    <map>
                        <entry key="MA" value-ref="mongoItemWriter:MA"/>
                        <entry key="MD" value-ref="mongoItemWriter:MD"/>
                        <entry key="MN" value-ref="mongoItemWriter:MN"/>
                        <entry key="GA" value-ref="mongoItemWriter:GA"/>
                        <entry key="GD" value-ref="mongoItemWriter:GD"/>
                        <entry key="GN" value-ref="mongoItemWriter:GN"/>
                        
                        <entry key="ME" value-ref="mongoItemWriter:ME"/>
                        <entry key="GE" value-ref="mongoItemWriter:GE"/>
                    </map>
                </property>
            </bean>
        </property>
    </bean>
    
    <bean id="abstractMongoItemWriter" class="org.springframework.batch.item.data.MongoItemWriter" abstract="true">
        <property name="template" ref="mongoTemplate"/>
    </bean>
    
    <bean id="mongoItemWriter:MA" parent="abstractMongoItemWriter" scope="step">
        <property name="collection" value="northamerica_imports_ma" />
    </bean>
    
    <bean id="mongoItemWriter:MD" parent="abstractMongoItemWriter" scope="step">
        <property name="collection" value="northamerica_imports_md" />
    </bean>
    
    <bean id="mongoItemWriter:MN" parent="abstractMongoItemWriter" scope="step">
        <property name="collection" value="northamerica_imports_mn" />
    </bean>
    
    <bean id="mongoItemWriter:ME" parent="abstractMongoItemWriter" scope="step">
        <property name="collection" value="northamerica_imports_me" />
    </bean>
    
    <bean id="mongoItemWriter:GA" parent="abstractMongoItemWriter" scope="step">
        <property name="collection" value="northamerica_imports_ga" />
    </bean>
    
    <bean id="mongoItemWriter:GD" parent="abstractMongoItemWriter" scope="step">
        <property name="collection" value="northamerica_imports_gd" />
    </bean>
    
    <bean id="mongoItemWriter:GN" parent="abstractMongoItemWriter" scope="step">
        <property name="collection" value="northamerica_imports_gn" />
    </bean>
    
    <bean id="mongoItemWriter:GE" parent="abstractMongoItemWriter" scope="step">
        <property name="collection" value="northamerica_imports_ge" />
    </bean>
</beans>